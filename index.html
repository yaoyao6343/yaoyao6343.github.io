<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.15" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> My New Hugo Site &middot; My New Hugo Site </title>

  
  <link rel="stylesheet" href="http://yaoyao6343.github.io/css/poole.css">
  <link rel="stylesheet" href="http://yaoyao6343.github.io/css/syntax.css">
  <link rel="stylesheet" href="http://yaoyao6343.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="http://yaoyao6343.github.io/index.xml" rel="alternate" type="application/rss+xml" title="My New Hugo Site" />
</head>

<body class=" ">

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://yaoyao6343.github.io/"><h1>My New Hugo Site</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
    </ul>

    <p>&copy; 2016. All rights reserved. </p>
  </div>
</div>


    <div class="content container">
<div class="posts">

      
  <div class="post">
    <h1 class="post-title">
      <a href="http://yaoyao6343.github.io/ServerMonitor/">
        first
      </a>
    </h1>

    <span class="post-date">Wed, Mar 30, 2016</span>

    

<h2 id="shell监控cpu-memory-load-average:a3972792808592970a64e78693571f2a">shell监控cpu/memory/load average</h2>

<p><strong>原理：</strong>
&gt;1.获取cpu，memory，load average的数值
&gt;2.判断数值是否超过自定义的范围，例如（CPU&gt;90%，Memory<10%，load average>2）
&gt;3.如数值超过范围，发送邮件通知管理员。发送有时间间隔，每小时只会发送一次。
&gt;4.将数值写入log。
&gt;5.设置crontab 每30秒运行一次。</p>

<p><strong>ServerMonitor.sh</strong></p>

<pre><code>#!/bin/bash
# 系统监控,记录cpu、memory、load average,当超过规定数值时发邮件通知管理员

# *** config start ***
# 当前目录路径
ROOT=$(cd &quot;$(dirname &quot;$0&quot;)&quot;; pwd)

# 当前服务器名
HOST=$(hostname)

# log 文件路径
CPU_LOG=&quot;${ROOT}/logs/cpu.log&quot;
MEM_LOG=&quot;${ROOT}/logs/mem.log&quot;
LOAD_LOG=&quot;${ROOT}/logs/load.log&quot;

# 通知邮件列表
NOTICE_EMAIL='admin@admin.com'

# cpu,memory,load average 记录上一次发送通知邮件时间
CPU_REMARK='/tmp/servermonitor_cpu.remark'
MEM_REMARK='/tmp/servermonitor_mem.remark'
LOAD_REMARK='/tmp/servermonitor_loadaverage.remark'

# 发通知邮件间隔时间
REMARK_EXPIRE=3600
NOW=$(date +%s)

# *** config end ***

# *** function start ***
# 获取CPU占用
function GetCpu() {
    cpufree=$(vmstat 1 5 |sed -n '3,$p' |awk '{x = x + $15} END {print x/5}' |awk -F. '{print $1}')
    cpuused=$((100 - $cpufree))
    echo $cpuused

    local remark
    remark=$(GetRemark ${CPU_REMARK})
    # 检查CPU占用是否超过90%
    if [ &quot;$remark&quot; = &quot;&quot; ] &amp;&amp; [ &quot;$cpuused&quot; -gt 90 ]; then
        echo &quot;Subject: ${HOST} CPU uses more than 90% $(date +%Y-%m-%d' '%H:%M:%S)&quot; | sendmail ${NOTICE_EMAIL}
        echo &quot;$(date +%s)&quot; &gt; &quot;$CPU_REMARK&quot;
    fi
}

# 获取内存使用情况
function GetMem() {
    mem=$(free -m | sed -n '3,3p')
    used=$(echo $mem | awk -F ' ' '{print $3}')
    free=$(echo $mem | awk -F ' ' '{print $4}')
    total=$(($used + $free))
    limit=$(($total/10))
    echo &quot;${total} ${used} ${free}&quot;

    local remark
    remark=$(GetRemark ${MEM_REMARK})

    # 检查内存占用是否超过90%
    if [ &quot;$remark&quot; = &quot;&quot; ] &amp;&amp; [ &quot;$limit&quot; -gt &quot;$free&quot; ]; then
        echo &quot;Subject: ${HOST} Memory uses more than 90% $(date +%Y-%m-%d' '%H:%M:%S)&quot; | sendmail ${NOTICE_EMAIL}
        echo &quot;$(date +%s)&quot; &gt; &quot;$MEM_REMARK&quot;
    fi
}

# 获取load average
function GetLoad() {
    load=$(uptime | awk -F 'load average: ' '{print $2}')
    m1=$(echo $load | awk -F ', ' '{print $1}')
    m5=$(echo $load | awk -F ', ' '{print $2}')
    m15=$(echo $load | awk -F ', ' '{print $3}')
    echo &quot;${m1} ${m5} ${m15}&quot;

    m1u=$(echo $m1 | awk -F '.' '{print $1}')

    local remark
    remark=$(GetRemark ${LOAD_REMARK})
    
    # 检查是否负载是否有压力
    if [ &quot;$remark&quot; = &quot;&quot; ] &amp;&amp; [ &quot;$m1u&quot; -gt &quot;2&quot; ]; then
        echo &quot;Subject: ${HOST} Load Average more than 2 $(date +%Y-%m-%d' '%H:%M:%S)&quot; | sendmail ${NOTICE_EMAIL}
        echo &quot;$(date +%s)&quot; &gt; &quot;$LOAD_REMARK&quot;
    fi
}

# 获取上一次发送邮件时间
function GetRemark() {
    local remark
    
    if [ -f &quot;$1&quot; ] &amp;&amp; [ -s &quot;$1&quot; ]; then
        remark=$(cat $1)
        if [ $(( $NOW - $remark )) -gt &quot;$REMARK_EXPIRE&quot; ]; then
            rm -f $1
            remark=&quot;&quot;
        fi
    else
        remark=&quot;&quot;
    fi
    echo $remark
}

# *** function end ***

cpuinfo=$(GetCpu)
meminfo=$(GetMem)
loadinfo=$(GetLoad)

echo &quot;cpu: ${cpuinfo}&quot; &gt;&gt; &quot;${CPU_LOG}&quot;
echo &quot;mem: ${meminfo}&quot; &gt;&gt; &quot;${MEM_LOG}&quot;
echo &quot;load: ${loadinfo}&quot; &gt;&gt; &quot;${LOAD_LOG}&quot;

exit 0
</code></pre>

<p><strong>crontab</strong></p>

<pre><code>* * * * * /home/xxxx/ServerMonitor.sh
* * * * * sleep 30; /home/xxxx/ServerMonitor.sh
</code></pre>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://yaoyao6343.github.io/post/first/">
        first
      </a>
    </h1>

    <span class="post-date">Wed, Mar 30, 2016</span>

    

<h3 id="hello-world:e8fb9c67eba912c72729806db31eaa1b">Hello World!</h3>

<ol>
<li>AAA</li>
<li>BBB</li>
<li>CCC</li>
</ol>

  </div>
  
</div>
</div>

  </body>
</html>
